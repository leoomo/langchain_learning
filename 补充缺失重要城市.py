#!/usr/bin/env python3
"""
è¡¥å……ç¼ºå¤±çš„é‡è¦åŸå¸‚åˆ°æ•°æ®åº“
åŒ…æ‹¬æ™¯å¾·é•‡ã€èµ£å·ã€ä¹æ±Ÿç­‰æ±Ÿè¥¿çœé‡è¦åœ°çº§å¸‚
"""

import sqlite3
from pathlib import Path
import logging

# è®¾ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def add_missing_cities():
    """è¡¥å……ç¼ºå¤±çš„é‡è¦åŸå¸‚"""
    db_path = "data/admin_divisions.db"

    if not Path(db_path).exists():
        logger.error("âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨")
        return

    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # ç¼ºå¤±çš„é‡è¦åœ°çº§å¸‚æ•°æ®
    missing_cities = [
        # æ±Ÿè¥¿çœç¼ºå¤±çš„åœ°çº§å¸‚
        ("360200", "æ™¯å¾·é•‡å¸‚", "360000", 2, 117.2147, 29.2975, "jingdezhen", '["ç“·éƒ½", "æ˜Œå—"]'),
        ("360700", "èµ£å·å¸‚", "360000", 2, 114.9403, 25.8316, "ganzhou", '["èµ£å—", "æ±Ÿå—å®‹åŸ"]'),
        ("360400", "ä¹æ±Ÿå¸‚", "360000", 2, 115.9929, 29.7120, "jiujiang", '["æµ”é˜³", "æ±Ÿå·"]'),
        ("360500", "æ–°ä½™å¸‚", "360000", 2, 114.9308, 27.8174, "xinyu", '["é’¢åŸ"]'),
        ("360600", "é¹°æ½­å¸‚", "360000", 2, 117.0339, 28.2384, "yingtan", '["é“éƒ½", "é“œéƒ½"]'),
        ("360800", "å‰å®‰å¸‚", "360000", 2, 114.9864, 27.1117, "jian", '["åºé™µ", "æ±Ÿå—æœ›éƒ¡"]'),
        ("360900", "å®œæ˜¥å¸‚", "360000", 2, 114.3916, 27.8043, "yichun", '["è¢å·", "æœˆäº®ä¹‹éƒ½"]'),
        ("361000", "æŠšå·å¸‚", "360000", 2, 116.3583, 27.9838, "fuzhou_jx", '["ä¸´å·", "æ‰å­ä¹‹ä¹¡"]'),
        ("361100", "ä¸Šé¥¶å¸‚", "360000", 2, 117.9434, 28.4576, "shangrao", '["ä¿¡å·", "è±«ç« ç¬¬ä¸€é—¨æˆ·"]'),

        # å…¶ä»–çœä»½ç¼ºå¤±çš„é‡è¦åœ°çº§å¸‚
        # å®‰å¾½çœ
        ("340300", "èŠœæ¹–å¸‚", "340000", 2, 118.3763, 31.3263, "wuhu", '["æ±ŸåŸ", "ä¸­æ±Ÿ"]'),
        ("340400", "èšŒåŸ å¸‚", "340000", 2, 117.3634, 32.9416, "bengbu", '["ç åŸ"]'),
        ("340500", "æ·®å—å¸‚", "340000", 2, 117.0183, 32.6479, "huainan", '["ç…¤éƒ½"]'),
        ("340600", "é©¬éå±±å¸‚", "340000", 2, 118.5077, 31.6890, "maanshan", '["é’¢åŸ"]'),
        ("340700", "æ·®åŒ—å¸‚", "340000", 2, 116.7948, 33.9717, "huaibei", '["ç›¸åŸ"]'),
        ("340800", "é“œé™µå¸‚", "340000", 2, 117.8122, 30.9299, "tongling", '["é“œéƒ½"]'),
        ("341000", "é»„å±±å¸‚", "340000", 2, 118.3177, 29.7092, "huangshan", '["å¾½å·", "æ–°å®‰"]'),
        ("341100", "æ»å·å¸‚", "340000", 2, 118.3163, 32.3017, "chuzhou", '["çš–ä¸œ"]'),
        ("341200", "é˜œé˜³å¸‚", "340000", 2, 115.8197, 32.8969, "fuyang", '["é¢å·"]'),
        ("341300", "å®¿å·å¸‚", "340000", 2, 116.9784, 33.6336, "suzhou_ah", '["å®¿åŸ"]'),
        ("341500", "å…­å®‰å¸‚", "340000", 2, 116.5078, 31.7529, "luan", '["çš‹åŸ"]'),
        ("341600", "äº³å·å¸‚", "340000", 2, 115.7830, 33.8712, "bozhou", '["è°¯åŸ"]'),
        ("341700", "æ± å·å¸‚", "340000", 2, 117.4892, 30.6568, "chizhou", '["ç§‹æµ¦"]'),
        ("341800", "å®£åŸå¸‚", "340000", 2, 118.7519, 30.9459, "xuancheng", '["å®›é™µ"]'),

        # æ²³å—çœç¼ºå¤±çš„åœ°çº§å¸‚
        ("410300", "æ´›é˜³å¸‚", "410000", 2, 112.4540, 34.6197, "luoyang", '["ç¥éƒ½", "æ´›åŸ"]'),
        ("410400", "å¹³é¡¶å±±å¸‚", "410000", 2, 113.3073, 33.7353, "pingdingshan", '["é¹°åŸ"]'),
        ("410500", "å®‰é˜³å¸‚", "410000", 2, 114.3524, 36.1034, "anyang", '["æ®·éƒ½", "é‚ºåŸ"]'),
        ("410600", "é¹¤å£å¸‚", "410000", 2, 114.2971, 35.8973, "hebi", '["æœæ­Œ"]'),
        ("410700", "æ–°ä¹¡å¸‚", "410000", 2, 113.9268, 35.3027, "xinxiang", '["ç‰§é‡"]'),
        ("410800", "ç„¦ä½œå¸‚", "410000", 2, 113.2418, 35.2395, "jiaozuo", '["å±±é˜³", "æ€€å·"]'),
        ("410900", "æ¿®é˜³å¸‚", "410000", 2, 115.0104, 35.7648, "puyang", '["é¾™ä¹¡"]'),
        ("411000", "è®¸æ˜Œå¸‚", "410000", 2, 113.8261, 34.0227, "xuchang", '["é­éƒ½", "é’§éƒ½"]'),
        ("411100", "æ¼¯æ²³å¸‚", "410000", 2, 114.0264, 33.5813, "luohe", '["é£Ÿå“ååŸ"]'),
        ("411200", "ä¸‰é—¨å³¡å¸‚", "410000", 2, 111.1948, 34.7773, "sanmenxia", '["å¤©é¹…åŸ"]'),
        ("411300", "å—é˜³å¸‚", "410000", 2, 112.5428, 32.9991, "nanyang", '["å®›åŸ", "å§é¾™"]'),
        ("411400", "å•†ä¸˜å¸‚", "410000", 2, 115.6506, 34.4144, "shangqiu", '["å•†éƒ½"]'),
        ("411500", "ä¿¡é˜³å¸‚", "410000", 2, 114.0672, 32.1234, "xinyang", '["ç”³åŸ", "èŒ¶éƒ½"]'),
        ("411600", "å‘¨å£å¸‚", "410000", 2, 114.6497, 33.6204, "zhoukou", '["é™ˆå·"]'),
        ("411700", "é©»é©¬åº—å¸‚", "410000", 2, 114.0247, 32.9802, "zhumadian", '["å¤©ä¸­"]'),
        ("419001", "æµæºå¸‚", "410000", 2, 112.6017, 35.0909, "jiyuan", '["æ„šå…¬æ•…é‡Œ"]'),

        # æ¹–å—çœç¼ºå¤±çš„åœ°çº§å¸‚
        ("430200", "æ ªæ´²å¸‚", "430000", 2, 113.1517, 27.8358, "zhuzhou", '["ç‚å¸", "åŠ¨åŠ›è°·"]'),
        ("430300", "æ¹˜æ½­å¸‚", "430000", 2, 112.9441, 27.8297, "xiangtan", '["è²åŸ", "æ½­åŸ"]'),
        ("430400", "è¡¡é˜³å¸‚", "430000", 2, 112.6077, 26.9004, "hengyang", '["é›åŸ", "è¡¡å·"]'),
        ("430500", "é‚µé˜³å¸‚", "430000", 2, 111.4682, 27.2389, "shaoyang", '["å®åº†"]'),
        ("430600", "å²³é˜³å¸‚", "430000", 2, 113.0963, 29.3571, "yueyang", '["å·´é™µ", "å²³å·"]'),
        ("430700", "å¸¸å¾·å¸‚", "430000", 2, 111.6990, 29.0312, "changde", '["æ­¦é™µ", "æŸ³åŸ"]'),
        ("430800", "å¼ å®¶ç•Œå¸‚", "430000", 2, 110.4793, 29.1278, "zhangjiajie", '["å¤§åº¸", "å›½é™…å¼ "]'),
        ("430900", "ç›Šé˜³å¸‚", "430000", 2, 112.3550, 28.5701, "yiyang", '["é“¶åŸ", "ä¸½éƒ½"]'),
        ("431000", "éƒ´å·å¸‚", "430000", 2, 113.0322, 25.7702, "chenzhou", '["æ—åŸ", "ç¦åŸ"]'),
        ("431100", "æ°¸å·å¸‚", "430000", 2, 111.6086, 26.4203, "yongzhou", '["æ½‡æ¹˜", "ç«¹åŸ"]'),
        ("431200", "æ€€åŒ–å¸‚", "430000", 2, 109.9770, 27.5501, "huaihua", '["é¹¤åŸ", "äº”æºª"]'),
        ("431300", "å¨„åº•å¸‚", "430000", 2, 112.0085, 27.7281, "loudi", '["æ¹˜ä¸­"]'),

        # æ¹–åŒ—çœç¼ºå¤±çš„åœ°çº§å¸‚
        ("420200", "é»„çŸ³å¸‚", "420000", 2, 115.0770, 30.2201, "huangshi", '["çŸ³åŸ"]'),
        ("420300", "åå °å¸‚", "420000", 2, 110.7850, 32.6474, "shiyan", '["è½¦åŸ", "å¡è½¦ä¹‹éƒ½"]'),
        ("420500", "å®œæ˜Œå¸‚", "420000", 2, 111.2908, 30.7026, "yichang", '["å¤·é™µ", "æ°´ç”µä¹‹éƒ½"]'),
        ("420600", "è¥„é˜³å¸‚", "420000", 2, 112.1441, 32.0420, "xiangyang", '["è¥„é˜³", "éš†ä¸­"]'),
        ("420700", "é„‚å·å¸‚", "420000", 2, 114.8953, 30.3965, "ezhou", '["å´éƒ½", "ç™¾æ¹–ä¹‹å¸‚"]'),
        ("420800", "è†é—¨å¸‚", "420000", 2, 112.2042, 31.0354, "jingmen", '["è†æ¥š", "å†œè°·"]'),
        ("420900", "å­æ„Ÿå¸‚", "420000", 2, 113.9267, 30.9265, "xiaogan", '["è‘£æ°¸æ•…é‡Œ"]'),
        ("421000", "è†å·å¸‚", "420000", 2, 112.2391, 30.3279, "jingzhou", '["æ±Ÿé™µ", "æ¥šå›½æ•…éƒ½"]'),
        ("421100", "é»„å†ˆå¸‚", "420000", 2, 114.8795, 30.4477, "huanggang", '["é»„å·", "ä¸œå¡èµ¤å£"]'),
        ("421200", "å’¸å®å¸‚", "420000", 2, 114.3220, 29.8418, "xianning", '["æ¡‚èŠ±ä¹‹ä¹¡"]'),
        ("421300", "éšå·å¸‚", "420000", 2, 113.3825, 31.7176, "suizhou", '["ç‚å¸æ•…é‡Œ", "ç¼–é’Ÿä¹‹ä¹¡"]'),
        ("422800", "æ©æ–½åœŸå®¶æ—è‹—æ—è‡ªæ²»å·", "420000", 2, 109.4880, 30.2831, "enshi", '["ä¸–ç•Œç¡’éƒ½"]'),

        # ç¦å»ºçœç¼ºå¤±çš„åœ°çº§å¸‚
        ("350300", "è†ç”°å¸‚", "350000", 2, 119.0076, 25.4310, "putian", '["å…´åŒ–", "å¦ˆç¥–æ•…ä¹¡"]'),
        ("350500", "æ³‰å·å¸‚", "350000", 2, 118.5854, 24.9088, "quanzhou", '["åˆºæ¡åŸ", "é²¤åŸ"]'),
        ("350600", "æ¼³å·å¸‚", "350000", 2, 117.6470, 24.5210, "zhangzhou", '["èŠ—åŸ", "æ°´ä»™èŠ±ä¹‹ä¹¡"]'),
        ("350700", "å—å¹³å¸‚", "350000", 2, 118.1784, 26.6359, "nanping", '["å‰‘å·", "é—½åŒ—"]'),
        ("350800", "é¾™å²©å¸‚", "350000", 2, 117.0179, 25.0913, "longyan", '["é—½è¥¿"]'),
        ("350900", "å®å¾·å¸‚", "350000", 2, 119.5271, 26.6592, "ningde", '["é—½ä¸œ", "å±±æµ·ä¹‹åŸ"]'),

        # å±±è¥¿çœç¼ºå¤±çš„åœ°çº§å¸‚
        ("140300", "é˜³æ³‰å¸‚", "140000", 2, 113.5833, 37.8612, "yangquan", '["ç…¤åŸ", "å±±åŸ"]'),
        ("140400", "é•¿æ²»å¸‚", "140000", 2, 113.1135, 36.2018, "changzhi", '["ä¸Šå…š"]'),
        ("140500", "æ™‹åŸå¸‚", "140000", 2, 112.8518, 35.4978, "jincheng", '["æ³½å·"]'),
        ("140600", "æœ”å·å¸‚", "140000", 2, 112.4334, 39.3312, "shuozhou", '["é©¬é‚‘"]'),
        ("140700", "æ™‹ä¸­å¸‚", "140000", 2, 112.7385, 37.6933, "jinzhong", '["æ¦†æ¬¡"]'),
        ("140800", "è¿åŸå¸‚", "140000", 2, 111.0059, 35.0228, "yuncheng", '["æ²³ä¸œ"]'),
        ("140900", "å¿»å·å¸‚", "140000", 2, 112.7338, 38.4086, "xinzhou", '["å¿»å·"]'),
        ("141000", "ä¸´æ±¾å¸‚", "140000", 2, 111.5180, 36.0882, "linfen", '["å¹³é˜³", "å°§éƒ½"]'),
        ("141100", "å•æ¢å¸‚", "140000", 2, 111.1349, 37.5194, "lvliang", '["ç¦»çŸ³"]'),

        # è¾½å®çœç¼ºå¤±çš„åœ°çº§å¸‚
        ("210300", "éå±±å¸‚", "210000", 2, 122.9956, 41.1106, "anshan", '["é’¢éƒ½"]'),
        ("210400", "æŠšé¡ºå¸‚", "210000", 2, 123.9570, 41.8650, "fushun", '["ç…¤éƒ½"]'),
        ("210500", "æœ¬æºªå¸‚", "210000", 2, 123.7853, 41.2942, "benxi", '["é’¢éƒ½"]'),
        ("210600", "ä¸¹ä¸œå¸‚", "210000", 2, 124.3545, 40.1244, "dandong", '["è¾¹åŸ"]'),
        ("210700", "é”¦å·å¸‚", "210000", 2, 121.1357, 41.1192, "jinzhou", '["é”¦ç»£ä¹‹å·"]'),
        ("210800", "è¥å£å¸‚", "210000", 2, 122.2350, 40.6733, "yingkou", '["å…³å¤–ä¸Šæµ·"]'),
        ("210900", "é˜œæ–°å¸‚", "210000", 2, 121.6587, 42.0119, "fuxin", '["ç…¤ç”µä¹‹åŸ"]'),
        ("211000", "è¾½é˜³å¸‚", "210000", 2, 123.1815, 41.2694, "liaoyang", '["å¤åŸ"]'),
        ("211100", "ç›˜é”¦å¸‚", "210000", 2, 122.0704, 41.1245, "panjin", '["æ¹¿åœ°ä¹‹éƒ½"]'),
        ("211200", "é“å²­å¸‚", "210000", 2, 123.8444, 42.2923, "tieling", '["ç…¤é“èƒ½æºä¹‹åŸ"]'),
        ("211300", "æœé˜³å¸‚", "210000", 2, 120.4515, 41.5718, "chaoyang_ln", '["é¾™åŸ"]'),
        ("211400", "è‘«èŠ¦å²›å¸‚", "210000", 2, 120.8560, 40.7555, "huludao", '["å…³å¤–ç¬¬ä¸€å¸‚"]'),
    ]

    insert_sql = '''
        INSERT OR REPLACE INTO regions
        (code, name, parent_code, level, longitude, latitude, pinyin, aliases,
         province, city, district, street, data_source)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    '''

    added_count = 0
    for city_data in missing_cities:
        code, name, parent_code, level, longitude, latitude, pinyin, aliases = city_data

        # å¡«å……å±‚çº§ä¿¡æ¯
        if level == 2:  # åœ°çº§å¸‚
            province = None
            # æ ¹æ®ä»£ç å‰ç¼€åˆ¤æ–­çœä»½
            if code.startswith('36'):
                province = "æ±Ÿè¥¿çœ"
            elif code.startswith('34'):
                province = "å®‰å¾½çœ"
            elif code.startswith('41'):
                province = "æ²³å—çœ"
            elif code.startswith('43'):
                province = "æ¹–å—çœ"
            elif code.startswith('42'):
                province = "æ¹–åŒ—çœ"
            elif code.startswith('35'):
                province = "ç¦å»ºçœ"
            elif code.startswith('14'):
                province = "å±±è¥¿çœ"
            elif code.startswith('21'):
                province = "è¾½å®çœ"

            city = name
        else:
            province = city = district = street = None

        try:
            cursor.execute(insert_sql, (
                code, name, parent_code, level, longitude, latitude, pinyin, aliases,
                province, city, None, None, 'manual_addition'
            ))
            added_count += 1
            logger.info(f"âœ… å·²æ·»åŠ : {name}")
        except Exception as e:
            logger.warning(f"âŒ æ·»åŠ å¤±è´¥ {name}: {e}")

    conn.commit()

    # éªŒè¯æ·»åŠ ç»“æœ
    cursor.execute("SELECT COUNT(*) FROM regions")
    total_count = cursor.fetchone()[0]

    cursor.execute("SELECT level, COUNT(*) FROM regions GROUP BY level ORDER BY level")
    level_stats = cursor.fetchall()

    logger.info(f"\nğŸ“Š è¡¥å……å®Œæˆç»Ÿè®¡:")
    logger.info(f"   æ–°å¢åŸå¸‚: {added_count}ä¸ª")
    logger.info(f"   æ•°æ®åº“æ€»è®¡: {total_count}ä¸ªåœ°åŒº")
    logger.info("ğŸ“‹ æŒ‰çº§åˆ«ç»Ÿè®¡:")
    for level, count in level_stats:
        level_name = {1: "çœçº§", 2: "åœ°çº§", 3: "å¿çº§", 4: "ä¹¡é•‡çº§", 5: "æ‘çº§"}.get(level, f"çº§åˆ«{level}")
        logger.info(f"   {level_name}: {count}ä¸ª")

    # æµ‹è¯•æ™¯å¾·é•‡æ˜¯å¦èƒ½åŒ¹é…
    from enhanced_place_matcher import EnhancedPlaceMatcher
    matcher = EnhancedPlaceMatcher()
    matcher.connect()

    result = matcher.match_place("æ™¯å¾·é•‡")
    if result:
        logger.info(f"\nğŸ‰ æµ‹è¯•æ™¯å¾·é•‡åŒ¹é…: âœ… æˆåŠŸ")
        logger.info(f"   åŒ¹é…ç»“æœ: {result['name']} ({result['level_name']})")
        logger.info(f"   åæ ‡: ({result['longitude']:.4f}, {result['latitude']:.4f})")
    else:
        logger.error(f"\nâŒ æ™¯å¾·é•‡åŒ¹é…å¤±è´¥")

    matcher.close()
    conn.close()

if __name__ == "__main__":
    add_missing_cities()