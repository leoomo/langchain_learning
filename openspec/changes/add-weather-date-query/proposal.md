# 提案：添加查询指定日期天气功能

## 📋 概述

为天气查询工具添加日期参数支持，允许用户查询历史天气和未来天气预报。

## 🎯 目标

- 支持查询指定日期的天气信息
- 提供历史天气数据查询能力
- 支持未来天气预报查询
- **新增：支持时间粒度细化查询（上午、下午、晚上、早上等）**
- 保持与现有天气工具的兼容性

## 🚀 变更内容

### 修改天气工具 (tools/weather_tool.py)

## ADDED Requirements

#### 场景1：历史天气查询
用户可以查询过去某天的天气信息，例如：
- "查询昨天北京的天气"
- "上周三上海下雨了吗"
- "2024年10月1日杭州的气温"

#### 场景2：未来天气预报
用户可以查询未来几天的天气预报，例如：
- "查询明天广州的天气预报"
- "下周深圳会下雨吗"
- "2025年1月1日北京天气如何"

#### 场景3：时间粒度细化查询
用户可以查询指定日期内特定时间段的天气，例如：
- "明天上午北京天气怎么样？"
- "后天下午上海会下雨吗？"
- "周五晚上杭州适合出门吗？"
- "今天早上深圳需要带伞吗？"
- "2024年12月25日晚上广州天气如何？"

#### 场景4：日期范围查询
用户可以查询指定日期范围的天气统计，例如：
- "查询过去一周北京的平均气温"
- "下周上海会下雨几天"
- "本月深圳的最高气温"

## 🛠️ 技术实现

### 1. 数据源扩展

#### 彩云天气API日期参数
- 使用彩云天气API的日期查询接口
- 支持查询历史天气（通常7天内）
- 支持查询未来预报（通常15天内）

#### 缓存策略
- 扩展现有缓存系统支持日期数据
- 按日期+地区进行缓存
- **新增：按日期+时间粒度+地区的精细化缓存**
- 历史数据长期缓存，预报数据短期缓存
- **新增：小时级预报数据短期缓存策略**

### 2. 接口设计

#### 新增函数签名
```python
def get_weather_by_date(place_name: str, date: str) -> WeatherData
def get_weather_forecast(place_name: str, days: int = 7) -> List[WeatherData]
def get_weather_history(place_name: str, days: int = 7) -> List[WeatherData]
# 新增：时间粒度查询函数
def get_weather_by_datetime(place_name: str, date: str, time_period: str = None) -> WeatherData
def get_hourly_forecast(place_name: str, hours: int = 24) -> List[WeatherData]
```

#### 日期格式支持
- 相对日期："yesterday", "tomorrow", "3天后", "上周三"
- 绝对日期："2024-12-25", "2025-01-01"
- 中文日期："2024年12月25日", "明天"

#### **新增：时间粒度格式支持**
- **时间段关键词**：
  - 早上：05:00-08:59
  - 上午：09:00-11:59
  - 中午：12:00-13:59
  - 下午：14:00-17:59
  - 晚上：18:00-21:59
  - 夜间：22:00-04:59
- **复合时间表达**：
  - "明天上午", "后天下午", "周五晚上"
  - "今天早上", "明天中午", "周末晚上"
  - "2024年12月25日晚上"

### 3. 工具集成

#### LangChain工具参数
```python
@tool
def query_weather_by_date(place: str, date: str = "today") -> str:
    """查询指定日期的天气信息

    Args:
        place: 地区名称
        date: 日期，支持"today", "yesterday", "tomorrow", "YYYY-MM-DD"等格式

    Returns:
        格式化的天气信息字符串
    """

# 新增：支持时间粒度的天气查询工具
@tool
def query_weather_by_datetime(place: str, datetime: str) -> str:
    """查询指定日期时间段的天气信息

    Args:
        place: 地区名称
        datetime: 日期时间，支持"明天上午", "后天下午", "周五晚上",
                  "今天早上", "2024-12-25晚上"等格式

    Returns:
        格式化的天气信息字符串，包含特定时间段的预报
    """
```

## 📋 任务清单

- [ ] 研究彩云天气API日期查询接口文档
- [ ] 扩展WeatherData模型支持日期字段
- [ ] 实现日期解析工具函数
- [ ] 更新weather_tool.py添加日期查询功能
- [ ] 扩展缓存系统支持日期数据
- [ ] 更新天气服务支持日期查询
- [ ] 编写日期查询功能的单元测试
- [ ] 集成测试验证新功能
- [ ] 更新相关文档

## ⚠️ 风险评估

### 技术风险
- API调用频率限制
- 历史数据可用性限制
- 日期格式解析复杂性

### 兼容性风险
- 现有工具接口变更
- 缓存策略调整
- 数据模型扩展

## 📊 验收标准

### 功能验收
- [ ] 支持查询历史7天内天气
- [ ] 支持查询未来15天预报
- [ ] 正确解析多种日期格式
- [ ] **支持时间粒度查询（早上、上午、中午、下午、晚上、夜间）**
- [ ] **支持复合时间表达（明天上午、周五晚上等）**
- [ ] **时间段天气数据准确性验证**
- [ ] 与现有工具兼容

### 性能验收
- [ ] 日期查询响应时间 < 3秒
- [ ] 缓存命中率 > 80%
- [ ] API调用次数优化

### 质量验收
- [ ] 单元测试覆盖率 > 90%
- [ ] 集成测试通过
- [ ] 错误处理完善

## 🔄 后续计划

### Phase 1: 基础实现
- 实现基本的日期查询功能
- 支持常用日期格式
- 基础缓存支持

### Phase 2: 功能扩展
- 支持更多日期格式
- 优化缓存策略
- 添加天气统计功能

### Phase 3: 高级功能
- 支持日期范围查询
- 天气趋势分析
- 历史数据对比
- **支持更复杂的时间表达（工作日下午、周末早上等）**
- **时间粒度查询的智能推荐**

## 📝 参考资料

- [彩云天气API文档](https://docs.caiyunapp.com/weather-api/v2/)
- [Python日期处理最佳实践](https://docs.python.org/3/library/datetime.html)
- [LangChain工具开发指南](https://docs.langchain.com/oss/python/modules/tools/)

---

**创建时间**: 2025-11-04
**创建人**: Claude Code Assistant
**状态**: ✅ 已批准并实施完成
**实施时间**: 2025-11-04
**实施内容**:
- ✅ 创建智能钓鱼分析工具
- ✅ 实现时间粒度细化查询功能
- ✅ 集成LangChain智能体
- ✅ 添加钓鱼专业知识系统提示词
- ✅ 实现基于天气条件的智能时间段推荐